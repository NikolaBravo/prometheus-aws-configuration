#cloud-config
users:
  - name: prometheus
    system: true

  - name: davidking
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC2a1hthz3fr/odHHUDPaRT0NpHNF6AK3LrnMm9x737eP3SQBejjqSMreUikYh36jTv4w5LiQ63npVlMp1zlQXAtc11st2tVEM+KiQQgWLlVUzNQCN/LPPlDOtR0oYDYUVQo/fZ5EBK6pi5f3jA9tMXghnSNvoUELSvuJmKYgRHRr4k1nl+8SKFs/ZdjEJDzZAnoZe8CEYT4J43HW0EKieUBf0KhbxUXfNNoe17FF5CH3z3/06Ebq6JaqinwUOb357SlV6k5+NARHgwITKYvajVKwrSggx/6WgcjEEKLwZWiHguPJakkr+oM7RKTn2kAeLEkegZGimYatsRxt592W+GzMpf5JXEfVnvfzQ39cSHHb4OLpCGDTXJadPgy7dNyRiHvwJD0qC6x4sTpAwWqQZxozAYXtKSg02v/b0Ai30AduHGhcaIV3/l/jkcluJ3LVtFp7xIyk4EvTnuJAC4+xRN42f+Zcv2iRc8/q4JRSiJ9XC/k4+3wrJ2bE7wLFWpsr91TAfvqg4kEOXA1KKIcASu+8Q5CFR3dGdSWNK/FYNReS1QMsrZp4tZvm50mL7H0NokQGkGTvBbLdZ7Lqj7tPe8uf4XoTxMbAmRUuhZOps0pgL6IIigDhUeXcnczIlg2lQRcIRxu9EQ44Qv+0QZp+5eZLJxgcklg4Z4JbHr7REb0w== david.king@digital.cabinet-office.gov.uk

  - name: chrispatuzzo
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDbNxGtzthC9mxoIHswOtrRihLTCQ8I/gsNW13UYykk6wHaZAbTaienTcmDoUFc60kUUgNu5615CD9rGWTULk/ZqjAWhFWmPL/Xk8TMKLGp3S9U1pFkE3e+1kbN0uOfopA6UxJXRMvH7jM0PyKXNifnYFdIEBN2wVyGS0RhLWjOBsirM9KRVUk9aeSPSoEDUSXWJSCa9M4bdCJfTgEbeJo+IS6Pv+ndtTVrGWXMXAOT1Xi8iTY7lkQOiO1iJjRfBKWM+ibMg1M0i/FWZUl2BnMK5fasJFd2zIGfX77vEEboLFg3WWPQK+wGC7Q+8V0mGtbtJgGfN5DbpmHJ4CYsakAzzGuggEKc+HUTBYLAAAenr5SiQP7H364i4f5Ir2DdrMynS1NfjOitLctTQIW+Ovx/8RWbKHwaKZRCzJxjoz/haJ+64NyUzF5a78hTKiKDlhPUwYrp+TdiFCAcTzxSZQPtGwc8kxumHeKhQz8uqId2A3tR0MXcOdfanRvOKCRbob1ymBt1edxCQVrsR4a3Z2pTqqkBuEd3QI0gTQO8d50JQybVZ5dZqNPtBjN+U+hKD6DRlZdrnIvMlkNf1SQWJCqaXQTzdT9XCPZFWuTNCH/bdqGrMZv85UGbEpRth+Y20nPVioJ74IMPsTmTdSoyM/fgSiAdYsO9GxTpLdz9cmFmQw== chris@patuzzo.co.uk

  - name: javiermarquez
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCgFAWj3tmZJyECfGaRPRnoH3vN4THILLPwl5PxXqd+UNcUFjS9UbMWIN4MBWGmX9sWWHEp0wHYUL5N+yYkXPIWi0ICrMP6DdZ6bR7OpUTRrblwOs69CmRIz9DRRVFstimceSyJg9n1Tvn8eDUGB6GgtrYhtSkRcEOdPLm4+2Hs8+Lm1AGOdZtVosrOeYUTHlhMUcJoppwvJhudEvDRuAqdlJb3EpgGmhB4/d8WXka36caCzmnubNgiR6bWylCUtyEtHk+Gdb2naV5WFkB+xRLzOCdrBS9rLl6UKKMBKRKti6c1SyQGP98ynwFaM+J9wiykXfpMFJRQ00UOkwyNa6hV45yy0O7zsPrFM+uIUMjHEROGB3uzhD/lZC/kferCmlLZncVkW4eNXIiWwm64piTFhhApEluyPG+9Zyg5quPh7Z6iMqgsoXEJOqQ01sS0XVSuG9+b0hXN6qLScFhRcS7x7oi60DSmhjwk1+rMYtmpGftBxpu5KslpygsN4ba13MUqvShjeeuNzAha+pGkSEvE/oR67voZlUqGeHipyZ3ox0dZ4YC7kGXu0jy17bEPeKWRv7+q95RShSKMVYAbR9CkI9gnaZ/nDU7OTP/yXjyvuf2HOk5iMBspRHZNiiEYfdFV8BpIxcM+4NDfnaB4tO4mDoBSqj8gO7ErAq3bP5sCCw== javier.marquez@digital.cabinet-office.gov.uk

  - name: jonathanhallam
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCbhuGtTqXfhGAJUREY8foyy522FQ9djFwYAat0QU2C8eg8TnoiGOxdJaHg3JRikDEJVrpjGyCs3PJMUoTOzeb29qt99fhMAajSEohAXZVFbDv8RUCE3S6EiZNi/F4aV9Mq86rbKOgJTPAnIBr3En6qnBR7Z7Xvu8ooVcAiB8dozFFSbgNitpjVLIFUx10LnzqwtI4TrLKP+aM5HwmIZ0B90cJOwfMOaD2tOqldRfowcaYAX0zloUxS6lTS8PSwLr2T27xT44OhvG6aNyVzNbXkhZphQ5qEPI0NIzjtb3GkiE17ApZIF3iAa422ONlz+LbGQrjFdAtvCgjDZ3McA+gddbbS1s5cg+dU7X6HM3F8bfasd4B1UJwRA18XfLHDhSRQsETfLsDHUgrosJTLAxmx41SPY8CSShVDx6q9M6POalzqU/2V924RvaODrbimfGBR64JZ8mbvnNB9kwxm2dBx+jDx51dgTs7k3+YjvYKWRVq1qJtgFFQcaH1nZagrj9SCKJ7Won5UfsZM32VS6QNVtavCpVSeaz26ajuMBnKqNIAP2fL0j/QDsRdBCrZGAH09QJ2Y1+N2I4pjb0Cr5/dbd++hf3rdNdRt/5pYjlr1x1enPTqfsZKKuSNKR+lkp6ttx7dlphxtRzqsuQqz3tImKwUXkxaMeKmSb4j/j7bGTw== jonathan.hallam@digital.cabinet-office.gov.uk


package_update: true
package_upgrade: true
packages: ['awscli', 'chrony', 'nginx']

write_files:
  - content: |
      [Unit]
      Description=Prometheus

      [Service]
      User=prometheus
      ExecStart=/opt/prometheus/prometheus --config.file="/etc/prometheus/prometheus.yml"
      WorkingDirectory=/opt/prometheus

      [Install]
      WantedBy = multi-user.target
    owner: root:root
    path: /etc/systemd/system/prometheus.service
    permissions: 0644
  - content: |
      server {
        listen 80 default_server;
        server_name ${domain_name};
        auth_basic "Prometheus";
        auth_basic_user_file /etc/nginx/.htpasswd;

        location / {
          proxy_pass  http://localhost:9090;
        }
      }
      server {
        listen 8080;
        resolver 10.0.0.2;

        location / {
          proxy_pass https://$host$uri;
          proxy_ssl_server_name on;
          proxy_set_header X-CF-APP-INSTANCE $arg_cf_app_instance;
        }
      }
    owner: root:root
    path: /etc/nginx/sites-available/default
    permissions: 0644
  - owner: root:root
    path: /etc/cron.d/sync_prometheus_config_s3
    content: "*/5 * * * * /usr/bin/aws s3 sync s3://gds-prometheus-config /etc/prometheus"
  - owner: root:root
    path: /etc/cron.d/sync_prometheus_config_s3_reboot
    content: "@reboot /usr/bin/aws s3 sync s3://gds-prometheus-config /etc/prometheus"
  - owner: root:root
    path: /etc/cron.d/lets_encrypt_renewal
    content: "* 7,19 * * * certbot renew --post-hook 'service nginx reload'"
  - owner: root:root
    path: /etc/nginx/.htpasswd
    permissions: 0444
    content: "grafana:$apr1$LDmrTU1C$i1TWO7EiXgmVVOm3xkdpr0"
  - owner: root:root
    path: /etc/filebeat/filebeat.yml
    permissions: 0444
    content: |
      filebeat.prospectors:
      - type: log
        enabled: true
        paths:
          - /var/log/nginx/*.log
        fields:
          type: nginx-access
        fields_under_root: true
        encoding: utf-8
        exclude_files: [".gz"]
        ignore_older: 3h

      output.logstash:
        hosts: ["${logstash_endpoint}:${logstash_port}"]
        loadbalance: true
        ssl.enabled: true

runcmd:
  - [ whoami ]
  - [ deluser, ubuntu ]
  - [ service, sshd, restart ]
  - [ bash, -c, "echo 'server 169.254.169.123 prefer iburst' >> /etc/chrony/chrony.conf" ] # Configure Amazon Time Sync
  - [ service, chrony, restart ]
  - [ mkdir, /opt/prometheus ] # Extracted prometheus tarball
  - [ mkdir, /etc/prometheus ] # Prometheus configuration
  - [ wget, -q, "https://github.com/prometheus/prometheus/releases/download/v${prometheus_version}/prometheus-${prometheus_version}.linux-amd64.tar.gz", -P, /tmp ]
  - [ tar, xzvf, /tmp/prometheus-${prometheus_version}.linux-amd64.tar.gz, --strip-components=1, -C, /opt/prometheus ]
  - [ aws, s3, sync, "s3://gds-prometheus-config", /etc/prometheus ]
  - [ chown, -R, "prometheus:prometheus", /opt/prometheus ]
  - [ chown, -R, "prometheus:prometheus", /etc/prometheus ]
  - [ systemctl, enable, --now, prometheus.service ] # Start Prometheus
  - [ add-apt-repository, "ppa:certbot/certbot", -y ]
  - [ bash, -c, "echo 'deb https://artifacts.elastic.co/packages/6.x/apt stable main' >> /etc/apt/sources.list.d/elastic-6.x.list" ]
  - [ bash, -c, "wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -" ]
  - [ apt-get, update ]
  - 'apt-get install -o Dpkg::Options::="--force-confold" filebeat python-certbot-nginx -y'
  - [ certbot, ${real_certificate == "yes" ? "" : "--staging"}, -d, ${domain_name}, -m, ${lets_encrypt_email}, --authenticator, standalone, --installer, nginx, --pre-hook, "nginx -s stop", --post-hook, "nginx", --agree-tos, -n, --redirect ]
  - [ systemctl, enable, filebeat ]
  - [ reboot ]
