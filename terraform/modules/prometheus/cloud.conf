#cloud-config
users:
  - name: prometheus
    system: true

  - name: davidking
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC2a1hthz3fr/odHHUDPaRT0NpHNF6AK3LrnMm9x737eP3SQBejjqSMreUikYh36jTv4w5LiQ63npVlMp1zlQXAtc11st2tVEM+KiQQgWLlVUzNQCN/LPPlDOtR0oYDYUVQo/fZ5EBK6pi5f3jA9tMXghnSNvoUELSvuJmKYgRHRr4k1nl+8SKFs/ZdjEJDzZAnoZe8CEYT4J43HW0EKieUBf0KhbxUXfNNoe17FF5CH3z3/06Ebq6JaqinwUOb357SlV6k5+NARHgwITKYvajVKwrSggx/6WgcjEEKLwZWiHguPJakkr+oM7RKTn2kAeLEkegZGimYatsRxt592W+GzMpf5JXEfVnvfzQ39cSHHb4OLpCGDTXJadPgy7dNyRiHvwJD0qC6x4sTpAwWqQZxozAYXtKSg02v/b0Ai30AduHGhcaIV3/l/jkcluJ3LVtFp7xIyk4EvTnuJAC4+xRN42f+Zcv2iRc8/q4JRSiJ9XC/k4+3wrJ2bE7wLFWpsr91TAfvqg4kEOXA1KKIcASu+8Q5CFR3dGdSWNK/FYNReS1QMsrZp4tZvm50mL7H0NokQGkGTvBbLdZ7Lqj7tPe8uf4XoTxMbAmRUuhZOps0pgL6IIigDhUeXcnczIlg2lQRcIRxu9EQ44Qv+0QZp+5eZLJxgcklg4Z4JbHr7REb0w== david.king@digital.cabinet-office.gov.uk

  - name: chrispatuzzo
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDOUbe2nGDjtS1GAS0b8O03VEu+61ONjPA0aF4UmyDLw2y4tUVAquZp/zmjBX7MmNUSGHJ2HNz88eNXrtSM9kvjRrGXBUA+TB0ztaSj09tm3gpAsM8r8evT2CocUYjnVpA6V5gQOERa96c+pp2i9q1YCKkiIrOWqCpLdiNWk1RKbN4zAKUi5m/JXG5PrR05UG1x4qTGP2GazpPo92h1JVkccoqyeehzrCtmpJGWaw6twBlWZqoaxTHAJUu8F7YUPhw6//Jxv4uJcbl73tGEfwLIYGIhY2l4l9ajzXEqG7x51xMXXpSZEvbSvDBwgrSQSvSt911M9hWqCpEl2ToEVh1meMKtGOFMQzdC4z0qtPuweWn5BW3YnV8/4eBO3WDvoyBnP1cAXfu/S8ZW1apRdDSfPvFObZjn4ed3uUMmG+oUlg0yip7vjKgO+X5ktLq4/Z1wUtAV1dUk9MdTuerB4cPQ00w3kc0aa1YgWUmxNwnGHuumk0f4fo/J4DLn8evZyE3eAqtQAPgEsoGgNzRQsR8GIepil9n68lnDva5gHHrxdWrmNmRwQEjSfb48ZoAdj/0IbyolgwBJz1yrYdbu0SVkP/bpFunp/AO93nlhtLjeJPp8e5cgjNIyN90gNTwMGMKdUQAaG5SotgaU9Hy1EzW1IGE7mMmp/y6ZL61oBtCwrQ== chris.patuzzo@digital.cabinet-office.gov.uk

  - name: javiermarquez
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCgFAWj3tmZJyECfGaRPRnoH3vN4THILLPwl5PxXqd+UNcUFjS9UbMWIN4MBWGmX9sWWHEp0wHYUL5N+yYkXPIWi0ICrMP6DdZ6bR7OpUTRrblwOs69CmRIz9DRRVFstimceSyJg9n1Tvn8eDUGB6GgtrYhtSkRcEOdPLm4+2Hs8+Lm1AGOdZtVosrOeYUTHlhMUcJoppwvJhudEvDRuAqdlJb3EpgGmhB4/d8WXka36caCzmnubNgiR6bWylCUtyEtHk+Gdb2naV5WFkB+xRLzOCdrBS9rLl6UKKMBKRKti6c1SyQGP98ynwFaM+J9wiykXfpMFJRQ00UOkwyNa6hV45yy0O7zsPrFM+uIUMjHEROGB3uzhD/lZC/kferCmlLZncVkW4eNXIiWwm64piTFhhApEluyPG+9Zyg5quPh7Z6iMqgsoXEJOqQ01sS0XVSuG9+b0hXN6qLScFhRcS7x7oi60DSmhjwk1+rMYtmpGftBxpu5KslpygsN4ba13MUqvShjeeuNzAha+pGkSEvE/oR67voZlUqGeHipyZ3ox0dZ4YC7kGXu0jy17bEPeKWRv7+q95RShSKMVYAbR9CkI9gnaZ/nDU7OTP/yXjyvuf2HOk5iMBspRHZNiiEYfdFV8BpIxcM+4NDfnaB4tO4mDoBSqj8gO7ErAq3bP5sCCw== javier.marquez@digital.cabinet-office.gov.uk

  - name: jonathanhallam
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCbhuGtTqXfhGAJUREY8foyy522FQ9djFwYAat0QU2C8eg8TnoiGOxdJaHg3JRikDEJVrpjGyCs3PJMUoTOzeb29qt99fhMAajSEohAXZVFbDv8RUCE3S6EiZNi/F4aV9Mq86rbKOgJTPAnIBr3En6qnBR7Z7Xvu8ooVcAiB8dozFFSbgNitpjVLIFUx10LnzqwtI4TrLKP+aM5HwmIZ0B90cJOwfMOaD2tOqldRfowcaYAX0zloUxS6lTS8PSwLr2T27xT44OhvG6aNyVzNbXkhZphQ5qEPI0NIzjtb3GkiE17ApZIF3iAa422ONlz+LbGQrjFdAtvCgjDZ3McA+gddbbS1s5cg+dU7X6HM3F8bfasd4B1UJwRA18XfLHDhSRQsETfLsDHUgrosJTLAxmx41SPY8CSShVDx6q9M6POalzqU/2V924RvaODrbimfGBR64JZ8mbvnNB9kwxm2dBx+jDx51dgTs7k3+YjvYKWRVq1qJtgFFQcaH1nZagrj9SCKJ7Won5UfsZM32VS6QNVtavCpVSeaz26ajuMBnKqNIAP2fL0j/QDsRdBCrZGAH09QJ2Y1+N2I4pjb0Cr5/dbd++hf3rdNdRt/5pYjlr1x1enPTqfsZKKuSNKR+lkp6ttx7dlphxtRzqsuQqz3tImKwUXkxaMeKmSb4j/j7bGTw== jonathan.hallam@digital.cabinet-office.gov.uk

  - name: davidjeche
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDOF8CzMROmqIH2ooKidlwD4dYLmC43LqhHGcekpuMNQtnHnK50TR3RmtTfWbjODKd7ndsqM3Qd2DV7VtxJScfIrLNHTwtqmSLDZwM5Z/rDmVSiMzdJvk5SGl4Kw6jRO7azq7xCTO0wxPxxofZWLpNPR/IvUsbfuP1P+MqqSRIn2SlzasW4qEJ2IE9h+IBi9ecEgt+/GDzdfpxoJCk9MKXWeIKT3Ct32ZZ+08BHNb10DfBJ4dIAsXrVQg13xI4Rdwstb+3mMdReVLazzZ3q3DCHp0oIyGVR/v+fCmga6EfUeobdmXjqEzzTJeBPZnMOGAwrlvgsDOgDABQgX5I8YUGn david.jeche@digital.cabinet-office.gov.uk

package_update: true
package_upgrade: true
packages: ['chrony', 'nginx', 'ruby', 'python-pip']

mounts:
 - [ xvdh, /mnt]


write_files:
  - content: |
      global:
        scrape_interval: 15s
      scrape_configs:
        - job_name: prometheus
          scrape_interval: 5s
          static_configs:
            - targets: ['localhost:9090']
        - job_name: paas-targets
          scheme: http
          proxy_url: 'http://localhost:8080'
          file_sd_configs:
            - files: ['/etc/prometheus/targets/*.json']
              refresh_interval: 30s
    owner: root:root
    path: /etc/prometheus/prometheus.yml
    permissions: 0644
  - content: |
      [Unit]
      Description=Prometheus

      [Service]
      User=prometheus
      ExecStart=/opt/prometheus/prometheus --config.file="/etc/prometheus/prometheus.yml" --storage.tsdb.path="/mnt/prometheus"
      WorkingDirectory=/opt/prometheus

      [Install]
      WantedBy = multi-user.target
    owner: root:root
    path: /etc/systemd/system/prometheus.service
    permissions: 0644
  - content: |
      server {
        listen 80 default_server;
        server_name ${domain_name};
        auth_basic "Prometheus";
        auth_basic_user_file /etc/nginx/.htpasswd;

        location / {
          proxy_pass  http://localhost:9090;
        }
      }
      server {
        listen 8080;
        resolver 10.0.0.2;

        location / {
          proxy_pass https://$host$uri;
          proxy_ssl_server_name on;
          proxy_set_header X-CF-APP-INSTANCE $arg_cf_app_guid:$arg_cf_app_instance_index;
          proxy_set_header Authorization "Bearer $arg_cf_app_guid";
        }
      }
    owner: root:root
    path: /etc/nginx/sites-available/default
    permissions: 0644
  - owner: root:root
    path: /etc/cron.d/sync_prometheus_discovery
    content: |
      PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
      */5 * * * * root cd /opt/cf_app_discovery/deploy && ./cf_app_discovery
  - owner: root:root
    path: /etc/cron.d/sync_prometheus_discovery_reboot
    content: |
      PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
      @reboot root cd /opt/cf_app_discovery/deploy && ./cf_app_discovery
  - owner: root:root
    path: /etc/cron.d/lets_encrypt_renewal
    content: |
      PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
      * 7,19 * * * root certbot renew --post-hook 'service nginx reload'
  - owner: root:root
    path: /etc/nginx/.htpasswd
    permissions: 0444
    content: "grafana:$apr1$LDmrTU1C$i1TWO7EiXgmVVOm3xkdpr0"
  - owner: root:root
    path: /etc/filebeat/filebeat.yml
    permissions: 0444
    content: |
      filebeat.prospectors:
      - type: log
        enabled: true
        paths:
          - /var/log/nginx/*.log
        fields:
          type: nginx-access
        fields_under_root: true
        encoding: utf-8
        exclude_files: [".gz"]
        ignore_older: 3h

      output.logstash:
        hosts: ["${logstash_endpoint}:${logstash_port}"]
        loadbalance: true
        ssl.enabled: true

runcmd:
  - [ whoami ]
  - [ deluser, ubuntu ]
  - [ service, sshd, restart ]
  - [ bash, -c, "echo 'server 169.254.169.123 prefer iburst' >> /etc/chrony/chrony.conf" ] # Configure Amazon Time Sync
  - [ service, chrony, restart ]
  - [ pip, install, --upgrade, pip ]
  - [ pip, install, awscli, --upgrade, --user ]
  - [ ln, -s, "/root/.local/bin/aws", /usr/local/bin/aws ]
  - [ gem, install, bundler ]
  - [ wget, -q, "https://github.com/alphagov/cf_app_discovery/archive/1.0.0.zip", -P, /tmp ]
  - [ unzip, -d, /tmp, /tmp/1.0.0.zip ]
  - [ mv, /tmp/cf_app_discovery-1.0.0, /opt/cf_app_discovery ]
  - [ bash, -c, "cd /opt/cf_app_discovery && bundle --without development" ]
  - [ mkdir, /opt/prometheus ] # Extracted prometheus tarball
  - [ mkdir, /etc/prometheus/targets ] # Prometheus target configurations
  - [ wget, -q, "https://github.com/prometheus/prometheus/releases/download/v${prometheus_version}/prometheus-${prometheus_version}.linux-amd64.tar.gz", -P, /tmp ]
  - [ tar, xzvf, /tmp/prometheus-${prometheus_version}.linux-amd64.tar.gz, --strip-components=1, -C, /opt/prometheus ]
  - [ mkdir, -p, /mnt/prometheus ]
  - [ chown, "prometheus:prometheus", /mnt/prometheus]
  - [ chown, -R, "prometheus:prometheus", /opt/prometheus ]
  - [ systemctl, enable, --now, prometheus.service ] # Start Prometheus
  - [ add-apt-repository, "ppa:certbot/certbot", -y ]
  - [ bash, -c, "echo 'deb https://artifacts.elastic.co/packages/6.x/apt stable main' >> /etc/apt/sources.list.d/elastic-6.x.list" ]
  - [ bash, -c, "wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -" ]
  - [ apt-get, update ]
  - 'apt-get install -o Dpkg::Options::="--force-confold" filebeat python-certbot-nginx -y'
  - [ certbot, ${real_certificate == "yes" ? "" : "--staging"}, -d, ${domain_name}, -m, ${lets_encrypt_email}, --authenticator, standalone, --installer, nginx, --pre-hook, "nginx -s stop", --post-hook, "nginx", --agree-tos, -n, --redirect ]
  - [ systemctl, enable, filebeat ]
  - [ reboot ]
