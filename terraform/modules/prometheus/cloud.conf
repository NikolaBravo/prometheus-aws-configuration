#cloud-config
users:
  - name: prometheus
    system: true

package_update: true
package_upgrade: true
packages: ['chrony', 'nginx', 'awscli']

write_files:
  - content: |
      global:
        scrape_interval: 15s
      scrape_configs:
        - job_name: prometheus
          scrape_interval: 5s
          static_configs:
            - targets: ['localhost:9090']
        - job_name: paas-targets
          scheme: http
          proxy_url: 'http://localhost:8080'
          file_sd_configs:
            - files: ['/etc/prometheus/targets/*.json']
              refresh_interval: 30s
    owner: root:root
    path: /etc/prometheus/prometheus.yml
    permissions: 0644
  - content: |
      [Unit]
      Description=Prometheus

      [Service]
      User=prometheus
      ExecStart=/opt/prometheus/prometheus --config.file="/etc/prometheus/prometheus.yml" --storage.tsdb.path="/mnt/prometheus"
      WorkingDirectory=/opt/prometheus

      [Install]
      WantedBy = multi-user.target
    owner: root:root
    path: /etc/systemd/system/prometheus.service
    permissions: 0644
  - content: |
      server {
        listen 80 default_server;
        server_name ${domain_name};
        auth_basic "Prometheus";
        auth_basic_user_file /etc/nginx/.htpasswd;

        location / {
          proxy_pass  http://localhost:9090;
        }
      }
      server {
        listen 8080;
        resolver 10.0.0.2;

        location / {
          proxy_pass https://$host$uri;
          proxy_ssl_server_name on;
          proxy_set_header X-CF-APP-INSTANCE $arg_cf_app_guid:$arg_cf_app_instance_index;
          proxy_set_header Authorization "Bearer $arg_cf_app_guid";
        }
      }
    owner: root:root
    path: /etc/nginx/sites-available/default
    permissions: 0644
  - owner: root:root
    path: /etc/cron.d/sync_prometheus_config_s3
    content: |
      PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
      */5 * * * * root aws s3 sync --delete s3://${config_bucket}/active /etc/prometheus/targets
  - owner: root:root
    path: /etc/cron.d/lets_encrypt_renewal
    content: |
      PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
      * 7,19 * * * root certbot renew --post-hook 'service nginx reload'
  - owner: root:root
    path: /etc/cron.d/puppet_agent_runner
    content: |
      PATH=/opt/puppetlabs/bin
      10,* * * * * root  cd /re-prometheus-cm && git pull && /opt/puppetlabs/bin/puppet apply /re-prometheus-cm/manifests/ --hiera_config=/re-prometheus-cm/hiera.yaml
  - owner: root:root
    path: /etc/nginx/.htpasswd
    permissions: 0444
    content: "grafana:$apr1$LDmrTU1C$i1TWO7EiXgmVVOm3xkdpr0"
  - owner: root:root
    path: /etc/filebeat/filebeat.yml
    permissions: 0444
    content: |
      filebeat.prospectors:
      - type: log
        enabled: true
        paths:
          - /var/log/nginx/*.log
        fields:
          type: nginx-access
        fields_under_root: true
        encoding: utf-8
        exclude_files: [".gz"]
        ignore_older: 3h

      output.logstash:
        hosts: ["${logstash_endpoint}:${logstash_port}"]
        loadbalance: true
        ssl.enabled: true

runcmd:
  - [ whoami ]
  - [ deluser, ubuntu ]
  - [ service, sshd, restart ]
  - [ bash, -c, "echo 'server 169.254.169.123 prefer iburst' >> /etc/chrony/chrony.conf" ] # Configure Amazon Time Sync
  - [ git, clone, "https://github.com/alphagov/re-prometheus-cm.git" ]
  - [ bash, /re-prometheus-cm/install_puppet_5_agent.sh ]
  - [ sudo, -E, /opt/puppetlabs/bin/puppet, apply, /re-prometheus-cm/manifests/, --hiera_config=/re-prometheus-cm/hiera.yaml ]
  - [ service, chrony, restart ]
  - [ mkdir, /opt/prometheus ] # Extracted prometheus tarball
  - [ mkdir, /etc/prometheus/targets ] # Prometheus target configurations
  - [ wget, -q, "https://github.com/prometheus/prometheus/releases/download/v${prometheus_version}/prometheus-${prometheus_version}.linux-amd64.tar.gz", -P, /tmp ]
  - [ tar, xzvf, /tmp/prometheus-${prometheus_version}.linux-amd64.tar.gz, --strip-components=1, -C, /opt/prometheus ]
  - [ mkdir, -p, /mnt/prometheus ]
  - [ chown, -R, "prometheus:prometheus", /mnt/prometheus]
  - [ chown, -R, "prometheus:prometheus", /opt/prometheus ]
  - [ systemctl, enable, --now, prometheus.service ] # Start Prometheus
  - [ add-apt-repository, "ppa:certbot/certbot", -y ]
  - [ bash, -c, "echo 'deb https://artifacts.elastic.co/packages/6.x/apt stable main' >> /etc/apt/sources.list.d/elastic-6.x.list" ]
  - [ bash, -c, "wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -" ]
  - [ apt-get, update ]
  - 'apt-get install -o Dpkg::Options::="--force-confold" filebeat python-certbot-nginx -y'
  - [ certbot, '${real_certificate == "yes" ? "" : "--staging"}', -d, ${domain_name}, -m, ${lets_encrypt_email}, --authenticator, standalone, --installer, nginx, --pre-hook, "nginx -s stop", --post-hook, "nginx", --agree-tos, -n, --redirect ]
  - [ systemctl, enable, filebeat ]
  - [ reboot ]
